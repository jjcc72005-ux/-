<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🎙️ مبدّل الصوت المحلي</title>
<style>
body {
  font-family: system-ui;
  background: #0b0b0b;
  color: #fff;
  text-align: center;
  padding: 40px;
}
select, button {
  margin: 10px;
  padding: 10px 20px;
  font-size: 16px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
}
button:hover {
  background: #333;
}
audio {
  margin-top: 25px;
  width: 80%;
}
</style>
</head>
<body>
<h2>🎧 مبدّل الصوت المحلي</h2>

<select id="effect">
  <option value="normal">صوت عادي</option>
  <option value="female">صوت بنت</option>
  <option value="old">صوت رجل عجوز</option>
  <option value="robot">صوت روبوت</option>
  <option value="echo">صوت مع صدى</option>
</select>

<br>

<button id="record">🎤 بدء التسجيل</button>
<button id="stop" disabled>⏹️ إيقاف</button>
<button id="download" disabled>⬇️ تحميل الصوت المعدّل</button>

<audio id="player" controls></audio>

<script>
let mediaRecorder, audioChunks = [], processedBlob = null;

const recordBtn = document.getElementById('record');
const stopBtn = document.getElementById('stop');
const downloadBtn = document.getElementById('download');
const player = document.getElementById('player');

recordBtn.onclick = async () => {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(stream);
  audioChunks = [];
  mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
  mediaRecorder.start();
  recordBtn.disabled = true;
  stopBtn.disabled = false;
};

stopBtn.onclick = () => {
  mediaRecorder.stop();
  stopBtn.disabled = true;
  recordBtn.disabled = false;
  mediaRecorder.onstop = () => {
    const blob = new Blob(audioChunks, { type: 'audio/webm' });
    applyEffect(blob);
  };
};

async function applyEffect(blob) {
  const effect = document.getElementById('effect').value;
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const arrayBuffer = await blob.arrayBuffer();
  const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

  const source = audioCtx.createBufferSource();
  source.buffer = audioBuffer;

  let nodeChain = source;

  // تأثيرات الصوت المختلفة
  switch (effect) {
    case 'female':
      source.playbackRate.value = 1.5;
      break;
    case 'old':
      source.playbackRate.value = 0.8;
      const lowFilter = audioCtx.createBiquadFilter();
      lowFilter.type = "lowpass";
      lowFilter.frequency.value = 1000;
      nodeChain.connect(lowFilter);
      nodeChain = lowFilter;
      break;
    case 'robot':
      const robotGain = audioCtx.createGain();
      robotGain.gain.value = 2.0;
      const robotDelay = audioCtx.createDelay();
      robotDelay.delayTime.value = 0.03;
      nodeChain.connect(robotGain);
      robotGain.connect(robotDelay);
      nodeChain = robotDelay;
      break;
    case 'echo':
      const delay = audioCtx.createDelay();
      delay.delayTime.value = 0.25;
      const feedback = audioCtx.createGain();
      feedback.gain.value = 0.4;
      delay.connect(feedback);
      feedback.connect(delay);
      nodeChain.connect(delay);
      nodeChain = delay;
      break;
  }

  // نوجّه الصوت للإخراج وللتسجيل معًا
  const dest = audioCtx.createMediaStreamDestination();
  nodeChain.connect(audioCtx.destination);
  nodeChain.connect(dest);

  // نبدأ التسجيل من الناتج الجديد
  const recorder = new MediaRecorder(dest.stream);
  const chunks = [];
  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.start();

  source.start();

  setTimeout(() => {
    recorder.stop();
    audioCtx.close();
  }, audioBuffer.duration * 1000);

  recorder.onstop = () => {
    processedBlob = new Blob(chunks, { type: 'audio/webm' });
    player.src = URL.createObjectURL(processedBlob);
    downloadBtn.disabled = false;
  };
}

downloadBtn.onclick = () => {
  if (!processedBlob) return;
  const a = document.createElement('a');
  a.href = URL.createObjectURL(processedBlob);
  a.download = 'voice_modified.webm';
  a.click();
};
</script>
</body>
</html>
