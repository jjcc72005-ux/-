<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR Tracer | ØªØªØ¨Ø¹ Ø§Ù„Ø±Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      overflow: hidden;
      background: #000;
      font-family: "Cairo", sans-serif;
      color: #fff;
      height: 100vh;
    }

    video, img {
      position: absolute;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      object-fit: cover;
    }

    #overlay {
      display: none;
      opacity: 0.5;
      object-fit: contain;
      transform: translate(-50%, -50%) scale(1);
      top: 50%;
      left: 50%;
      cursor: grab;
      user-select: none;
      touch-action: none;
      transition: opacity 0.3s ease;
    }

    #controls {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      background: rgba(0,0,0,0.65);
      padding: 12px;
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      backdrop-filter: blur(8px);
    }

    input[type="file"], button {
      color: white;
      background: #007bff;
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
    }

    input[type="range"] {
      width: 100%;
      cursor: pointer;
    }

    label { font-size: 14px; }

    button:hover {
      background: #0059c8;
    }
  </style>
</head>
<body>

  <video id="camera" autoplay playsinline></video>
  <img id="overlay" alt="Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©">

  <div id="controls">
    <input type="file" id="upload" accept="image/*">
    <button id="switchCam">ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ğŸ”„</button>
    
    <label>Ø´ÙØ§ÙÙŠØ© Ø§Ù„ØµÙˆØ±Ø©</label>
    <input type="range" id="opacity" min="0" max="1" step="0.1" value="0.5">

    <label>ØªÙƒØ¨ÙŠØ±/ØªØµØºÙŠØ±</label>
    <input type="range" id="scale" min="0.5" max="2" step="0.1" value="1">
  </div>

  <script>
    const video = document.getElementById('camera');
    const overlay = document.getElementById('overlay');
    const upload = document.getElementById('upload');
    const opacitySlider = document.getElementById('opacity');
    const scaleSlider = document.getElementById('scale');
    const switchBtn = document.getElementById('switchCam');

    let stream;
    let facingMode = "environment";
    let scale = 1, posX = 0, posY = 0, startX, startY, isDragging = false;

    // âœ… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
    async function startCamera() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
      }
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode } });
        video.srcObject = stream;
      } catch (err) {
        alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + err.message);
      }
    }

    // ğŸ” ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
    switchBtn.addEventListener('click', () => {
      facingMode = (facingMode === "environment") ? "user" : "environment";
      startCamera();
    });

    // ğŸ“¤ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
    upload.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        overlay.src = URL.createObjectURL(file);
        overlay.style.display = 'block';
        saveSettings();
      }
    });

    // âœï¸ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø´ÙØ§ÙÙŠØ©
    opacitySlider.addEventListener('input', e => {
      overlay.style.opacity = e.target.value;
      saveSettings();
    });

    // ğŸ” Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØªÙƒØ¨ÙŠØ±
    scaleSlider.addEventListener('input', e => {
      scale = e.target.value;
      updateTransform();
      saveSettings();
    });

    // ğŸ–ï¸ Ø§Ù„Ø³Ø­Ø¨ (ØªØ­Ø±ÙŠÙƒ Ø§Ù„ØµÙˆØ±Ø©)
    overlay.addEventListener('pointerdown', e => {
      isDragging = true;
      startX = e.clientX - posX;
      startY = e.clientY - posY;
      overlay.setPointerCapture(e.pointerId);
    });

    overlay.addEventListener('pointermove', e => {
      if (!isDragging) return;
      posX = e.clientX - startX;
      posY = e.clientY - startY;
      updateTransform();
    });

    overlay.addEventListener('pointerup', e => {
      isDragging = false;
      saveSettings();
    });

    function updateTransform() {
      overlay.style.transform = `translate(calc(-50% + ${posX}px), calc(-50% + ${posY}px)) scale(${scale})`;
    }

    // ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙŠ LocalStorage
    function saveSettings() {
      const settings = {
        opacity: opacitySlider.value,
        scale,
        posX,
        posY
      };
      localStorage.setItem("tracerSettings", JSON.stringify(settings));
    }

    // â™»ï¸ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    function loadSettings() {
      const saved = localStorage.getItem("tracerSettings");
      if (!saved) return;
      const { opacity, scale: s, posX: x, posY: y } = JSON.parse(saved);
      opacitySlider.value = opacity;
      scaleSlider.value = s;
      scale = s;
      posX = x;
      posY = y;
      overlay.style.opacity = opacity;
      updateTransform();
    }

    // ğŸš€ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    startCamera();
    loadSettings();
  </script>
</body>
</html>
