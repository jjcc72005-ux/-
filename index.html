<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>صوتي | محاكاة الأصوات</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #8A2BE2;
            --primary-light: #9d45e5;
            --secondary: #FF6B8B;
            --accent: #00CED1;
            --dark: #0F0F1E;
            --darker: #070711;
            --card-bg: #1A1A2E;
            --card-hover: #22223a;
            --text: #E6E6FA;
            --text-light: #B0B0CC;
            --success: #00FFAB;
            --warning: #FFD166;
            --danger: #FF6B8B;
            --gradient: linear-gradient(135deg, var(--primary), var(--secondary));
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: var(--darker);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: rgba(15, 15, 30, 0.9);
            backdrop-filter: blur(10px);
            padding: 1.8rem 0;
            text-align: center;
            border-radius: 24px;
            margin-bottom: 2.5rem;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(138, 43, 226, 0.15);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient);
        }
        
        .logo-area {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .logo-icon {
            font-size: 3rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            filter: drop-shadow(0 0 15px rgba(138, 43, 226, 0.5));
        }
        
        h1 {
            font-size: 3.2rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 25px rgba(138, 43, 226, 0.4);
            font-weight: 800;
            letter-spacing: -1px;
        }
        
        .subtitle {
            font-size: 1.3rem;
            color: var(--text-light);
            max-width: 600px;
            margin: 0 auto;
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 2.5rem;
        }
        
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }
        
        .panel {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }
        
        .panel:hover {
            transform: translateY(-7px);
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.3);
            background: var(--card-hover);
        }
        
        .panel-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 1.8rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .panel-header i {
            font-size: 1.8rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .panel h2 {
            color: var(--text);
            font-size: 1.7rem;
            font-weight: 700;
        }
        
        .visualizer-container {
            position: relative;
            width: 100%;
            height: 220px;
            background: linear-gradient(180deg, rgba(15, 15, 30, 0.7), rgba(7, 7, 17, 0.9));
            border-radius: 18px;
            margin: 1.8rem 0;
            overflow: hidden;
            border: 1px solid rgba(138, 43, 226, 0.15);
        }
        
        #visualizer {
            width: 100%;
            height: 100%;
        }
        
        .controls-row {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }
        
        .btn {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 1.2rem 2.5rem;
            border-radius: 60px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 8px 20px rgba(138, 43, 226, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(255,255,255,0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(138, 43, 226, 0.4);
        }
        
        .btn:hover::before {
            opacity: 1;
        }
        
        .btn:active {
            transform: translateY(2px);
        }
        
        .btn:disabled {
            background: #444;
            color: #777;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #ff8fa3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success), #00e6a0);
        }
        
        .audio-player {
            width: 100%;
            margin: 1.8rem 0;
            border-radius: 15px;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
        }
        
        .file-upload {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 1.8rem;
        }
        
        .file-input-label {
            padding: 2rem;
            border: 2px dashed rgba(255, 255, 255, 0.15);
            border-radius: 18px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .file-input-label:hover {
            border-color: var(--primary);
            background: rgba(138, 43, 226, 0.05);
        }
        
        .file-input-label i {
            font-size: 3rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .status {
            padding: 1.2rem;
            border-radius: 15px;
            margin: 1.8rem 0;
            text-align: center;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 1.1rem;
        }
        
        .status.recording {
            background: rgba(255, 107, 139, 0.1);
            color: var(--danger);
            border: 1px solid rgba(255, 107, 139, 0.3);
        }
        
        .status.processing {
            background: rgba(0, 206, 209, 0.1);
            color: var(--accent);
            border: 1px solid rgba(0, 206, 209, 0.3);
        }
        
        .status.success {
            background: rgba(0, 255, 171, 0.1);
            color: var(--success);
            border: 1px solid rgba(0, 255, 171, 0.3);
        }
        
        .hidden {
            display: none;
        }
        
        .reference-audio {
            background: rgba(138, 43, 226, 0.1);
            border: 2px solid var(--primary);
            border-radius: 18px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }
        
        .audio-analysis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .analysis-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
        }
        
        .analysis-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            margin: 0.5rem 0;
        }
        
        .analysis-label {
            font-size: 0.9rem;
            color: var(--text-light);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-area">
                <i class="fas fa-podcast logo-icon"></i>
                <h1>محاكي الأصوات</h1>
            </div>
            <p class="subtitle">ارفع صوتًا مرجعيًا وسأحول صوتك ليصبح مثله</p>
        </header>
        
        <div class="main-layout">
            <div class="left-panel">
                <div class="panel">
                    <div class="panel-header">
                        <i class="fas fa-microphone-alt"></i>
                        <h2>التسجيل والتحكم</h2>
                    </div>
                    
                    <div class="visualizer-container">
                        <canvas id="visualizer"></canvas>
                    </div>
                    
                    <div class="controls-row">
                        <button id="startRecord" class="btn">
                            <i class="fas fa-record-vinyl"></i>
                            <span>بدء التسجيل</span>
                        </button>
                        <button id="stopRecord" class="btn btn-danger" disabled>
                            <i class="fas fa-stop"></i>
                            <span>إيقاف التسجيل</span>
                        </button>
                    </div>
                    
                    <div id="recordStatus" class="status hidden">
                        <i class="fas fa-info-circle"></i>
                        <span>جاهز للتسجيل</span>
                    </div>
                </div>
                
                <div class="panel">
                    <div class="panel-header">
                        <i class="fas fa-play-circle"></i>
                        <h2>معاينة الصوت</h2>
                    </div>
                    <audio id="audioPlayer" controls class="audio-player"></audio>
                    <div class="controls-row">
                        <button id="downloadAudio" class="btn btn-success" disabled>
                            <i class="fas fa-download"></i>
                            <span>تحميل الصوت المعدل</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="right-panel">
                <div class="panel">
                    <div class="panel-header">
                        <i class="fas fa-music"></i>
                        <h2>الصوت المرجعي</h2>
                    </div>
                    
                    <div class="reference-audio">
                        <p>ارفع صوتًا تريد محاكاته:</p>
                        <div class="file-upload">
                            <label for="referenceUpload" class="file-input-label">
                                <i class="fas fa-upload"></i>
                                <span>اختر الصوت المرجعي</span>
                                <small>MP3, WAV, OGG</small>
                            </label>
                            <input type="file" id="referenceUpload" accept="audio/*" class="hidden">
                        </div>
                        
                        <audio id="referencePlayer" controls class="audio-player" style="display: none;"></audio>
                        
                        <div id="analysisResults" class="audio-analysis" style="display: none;">
                            <div class="analysis-item">
                                <div class="analysis-label">التردد الأساسي</div>
                                <div class="analysis-value" id="pitchValue">0 Hz</div>
                            </div>
                            <div class="analysis-item">
                                <div class="analysis-label">النبرة</div>
                                <div class="analysis-value" id="toneValue">-</div>
                            </div>
                            <div class="analysis-item">
                                <div class="analysis-label">السرعة</div>
                                <div class="analysis-value" id="tempoValue">-</div>
                            </div>
                            <div class="analysis-item">
                                <div class="analysis-label">الشدة</div>
                                <div class="analysis-value" id="intensityValue">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="controls-row">
                        <button id="analyzeAudio" class="btn" disabled>
                            <i class="fas fa-chart-line"></i>
                            <span>تحليل الصوت</span>
                        </button>
                        <button id="applyVoiceMatch" class="btn btn-success" disabled>
                            <i class="fas fa-magic"></i>
                            <span>تطبيق المحاكاة</span>
                        </button>
                    </div>
                </div>
                
                <div class="panel">
                    <div class="panel-header">
                        <i class="fas fa-sliders-h"></i>
                        <h2>ضبط المحاكاة</h2>
                    </div>
                    
                    <div class="tool-controls">
                        <div class="range-container">
                            <label for="pitchMatch">مطابقة التردد:</label>
                            <input type="range" id="pitchMatch" min="0" max="100" value="80">
                            <div class="range-value">
                                <span>منخفض</span>
                                <span>عالٍ</span>
                            </div>
                        </div>
                        
                        <div class="range-container">
                            <label for="timbreMatch">مطابقة النغمة:</label>
                            <input type="range" id="timbreMatch" min="0" max="100" value="70">
                            <div class="range-value">
                                <span>خفيف</span>
                                <span>كثيف</span>
                            </div>
                        </div>
                        
                        <div class="range-container">
                            <label for="rhythmMatch">مطابقة الإيقاع:</label>
                            <input type="range" id="rhythmMatch" min="0" max="100" value="60">
                            <div class="range-value">
                                <span>بطيء</span>
                                <span>سريع</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // العناصر الرئيسية
        const startRecordBtn = document.getElementById('startRecord');
        const stopRecordBtn = document.getElementById('stopRecord');
        const audioPlayer = document.getElementById('audioPlayer');
        const downloadBtn = document.getElementById('downloadAudio');
        const visualizerCanvas = document.getElementById('visualizer');
        const recordStatus = document.getElementById('recordStatus');
        
        // عناصر الصوت المرجعي
        const referenceUpload = document.getElementById('referenceUpload');
        const referencePlayer = document.getElementById('referencePlayer');
        const analyzeBtn = document.getElementById('analyzeAudio');
        const applyVoiceMatchBtn = document.getElementById('applyVoiceMatch');
        const analysisResults = document.getElementById('analysisResults');
        
        // عناصر التحكم
        const pitchMatch = document.getElementById('pitchMatch');
        const timbreMatch = document.getElementById('timbreMatch');
        const rhythmMatch = document.getElementById('rhythmMatch');
        
        // المتغيرات
        let audioContext;
        let analyser;
        let microphone;
        let audioStream;
        let recorder;
        let audioChunks = [];
        let audioBlob;
        let audioBuffer;
        let referenceBuffer;
        let voiceProfile = {};
        
        // التهيئة
        window.addEventListener('load', init);
        
        function init() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                setupVisualizer();
            } catch (e) {
                console.error('Web Audio API غير مدعوم', e);
                showStatus('Web Audio API غير مدعوم في هذا المتصفح', 'processing');
            }
            
            setupEventListeners();
        }
        
        function setupEventListeners() {
            // أحداث التسجيل
            startRecordBtn.addEventListener('click', startRecording);
            stopRecordBtn.addEventListener('click', stopRecording);
            
            // أحداث الصوت المرجعي
            referenceUpload.addEventListener('change', handleReferenceUpload);
            analyzeBtn.addEventListener('click', analyzeReferenceAudio);
            applyVoiceMatchBtn.addEventListener('click', applyVoiceMatching);
            
            // حدث التحميل
            downloadBtn.addEventListener('click', downloadAudio);
        }
        
        function setupVisualizer() {
            const canvasContext = visualizerCanvas.getContext('2d');
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            visualizerCanvas.width = visualizerCanvas.offsetWidth;
            visualizerCanvas.height = visualizerCanvas.offsetHeight;
            
            function draw() {
                requestAnimationFrame(draw);
                
                analyser.getByteFrequencyData(dataArray);
                
                canvasContext.fillStyle = 'rgba(7, 7, 17, 0.1)';
                canvasContext.fillRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
                
                const barWidth = (visualizerCanvas.width / bufferLength) * 2.5;
                let barHeight;
                let x = 0;
                
                for(let i = 0; i < bufferLength; i++) {
                    barHeight = dataArray[i] / 2;
                    
                    const gradient = canvasContext.createLinearGradient(0, visualizerCanvas.height - barHeight, 0, visualizerCanvas.height);
                    gradient.addColorStop(0, '#8A2BE2');
                    gradient.addColorStop(0.5, '#FF6B8B');
                    gradient.addColorStop(1, '#00CED1');
                    
                    canvasContext.fillStyle = gradient;
                    canvasContext.fillRect(x, visualizerCanvas.height - barHeight, barWidth, barHeight);
                    
                    x += barWidth + 1;
                }
            }
            
            draw();
        }
        
        async function startRecording() {
            try {
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                recorder = new MediaRecorder(audioStream);
                audioChunks = [];
                
                recorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                recorder.onstop = () => {
                    audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    audioPlayer.src = audioUrl;
                    
                    const fileReader = new FileReader();
                    fileReader.onload = function() {
                        audioContext.decodeAudioData(this.result, (buffer) => {
                            audioBuffer = buffer;
                        });
                    };
                    fileReader.readAsArrayBuffer(audioBlob);
                    
                    downloadBtn.disabled = false;
                    showStatus('تم التسجيل بنجاح!', 'success');
                };
                
                if (audioContext && analyser) {
                    microphone = audioContext.createMediaStreamSource(audioStream);
                    microphone.connect(analyser);
                }
                
                recorder.start();
                startRecordBtn.disabled = true;
                stopRecordBtn.disabled = false;
                showStatus('جاري التسجيل...', 'recording');
                
            } catch (error) {
                console.error('خطأ في التسجيل:', error);
                showStatus('خطأ في الوصول إلى الميكروفون', 'processing');
            }
        }
        
        function stopRecording() {
            if (recorder && recorder.state !== 'inactive') {
                recorder.stop();
                audioStream.getTracks().forEach(track => track.stop());
                startRecordBtn.disabled = false;
                stopRecordBtn.disabled = true;
                showStatus('جاري معالجة الصوت...', 'processing');
            }
        }
        
        function handleReferenceUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const fileReader = new FileReader();
            
            fileReader.onload = function() {
                const audioUrl = URL.createObjectURL(file);
                referencePlayer.src = audioUrl;
                referencePlayer.style.display = 'block';
                
                audioContext.decodeAudioData(this.result, (buffer) => {
                    referenceBuffer = buffer;
                    analyzeBtn.disabled = false;
                });
            };
            
            fileReader.readAsArrayBuffer(file);
        }
        
        function analyzeReferenceAudio() {
            if (!referenceBuffer) return;
            
            showStatus('جاري تحليل الصوت المرجعي...', 'processing');
            
            // محاكاة تحليل الصوت (في التطبيق الحقيقي، هذا يتطلب خوارزميات متقدمة)
            setTimeout(() => {
                // استخراج خصائص الصوت المرجعي
                voiceProfile = {
                    pitch: estimatePitch(referenceBuffer),
                    tempo: estimateTempo(referenceBuffer),
                    intensity: estimateIntensity(referenceBuffer),
                    spectral: analyzeSpectralCharacteristics(referenceBuffer)
                };
                
                // عرض النتائج
                document.getElementById('pitchValue').textContent = Math.round(voiceProfile.pitch) + ' Hz';
                document.getElementById('toneValue').textContent = getToneDescription(voiceProfile.pitch);
                document.getElementById('tempoValue').textContent = voiceProfile.tempo;
                document.getElementById('intensityValue').textContent = voiceProfile.intensity;
                
                analysisResults.style.display = 'grid';
                applyVoiceMatchBtn.disabled = false;
                
                showStatus('تم تحليل الصوت المرجعي بنجاح!', 'success');
            }, 2000);
        }
        
        function applyVoiceMatching() {
            if (!audioBuffer || !voiceProfile.pitch) {
                alert('يرجى تسجيل صوتك وتحليل الصوت المرجعي أولاً');
                return;
            }
            
            showStatus('جاري محاكاة الصوت...', 'processing');
            
            // محاكاة عملية المطابقة
            setTimeout(() => {
                const processedBuffer = applyVoiceTransformation(audioBuffer, voiceProfile);
                
                const wavBlob = bufferToWave(processedBuffer, processedBuffer.length);
                const audioUrl = URL.createObjectURL(wavBlob);
                audioPlayer.src = audioUrl;
                
                showStatus('تم محاكاة الصوت بنجاح!', 'success');
            }, 1500);
        }
        
        // وظائف تحليل الصوت (مبسطة)
        function estimatePitch(buffer) {
            // محاكاة حساب التردد الأساسي
            const sampleRate = buffer.sampleRate;
            const data = buffer.getChannelData(0);
            
            // خوارزمية مبسطة لاكتشاف التردد
            let maxVal = 0;
            let pitch = 0;
            
            for (let i = 0; i < data.length - 1; i++) {
                if (Math.abs(data[i]) > maxVal) {
                    maxVal = Math.abs(data[i]);
                    pitch = sampleRate / (i + 1);
                }
            }
            
            return Math.min(Math.max(pitch, 80), 400); // نطاق صوتي معقول
        }
        
        function estimateTempo(buffer) {
            const duration = buffer.duration;
            if (duration < 2) return 'سريع';
            if (duration > 5) return 'بطيء';
            return 'معتدل';
        }
        
        function estimateIntensity(buffer) {
            const data = buffer.getChannelData(0);
            let sum = 0;
            
            for (let i = 0; i < data.length; i++) {
                sum += Math.abs(data[i]);
            }
            
            const average = sum / data.length;
            if (average < 0.01) return 'هادئ';
            if (average > 0.1) return 'عالي';
            return 'متوسط';
        }
        
        function analyzeSpectralCharacteristics(buffer) {
            // محاكاة تحليل الطيف
            return {
                brightness: 0.7,
                warmth: 0.6,
                clarity: 0.8
            };
        }
        
        function getToneDescription(pitch) {
            if (pitch < 150) return 'عميق';
            if (pitch < 250) return 'وسط';
            return 'عالي';
        }
        
        function applyVoiceTransformation(sourceBuffer, targetProfile) {
            // إنشاء buffer جديد
            const newBuffer = audioContext.createBuffer(
                sourceBuffer.numberOfChannels,
                sourceBuffer.length,
                sourceBuffer.sampleRate
            );
            
            // نسبة المطابقة من عناصر التحكم
            const pitchRatio = pitchMatch.value / 100;
            const timbreRatio = timbreMatch.value / 100;
            const rhythmRatio = rhythmMatch.value / 100;
            
            for (let channel = 0; channel < sourceBuffer.numberOfChannels; channel++) {
                const sourceData = sourceBuffer.getChannelData(channel);
                const newData = newBuffer.getChannelData(channel);
                
                for (let i = 0; i < sourceData.length; i++) {
                    let sample = sourceData[i];
                    
                    // تطبيق تغييرات بناءً على الصوت المرجعي
                    if (targetProfile.pitch > 200) {
                        // إذا كان الصوت المرجعي عالي النبرة
                        sample = sample * (1 + pitchRatio * 0.3);
                    } else {
                        // إذا كان الصوت المرجعي منخفض النبرة
                        sample = sample * (1 - pitchRatio * 0.2);
                    }
                    
                    // تطبيق تغييرات النغمة
                    sample = applyTimbreAdjustment(sample, timbreRatio, targetProfile.spectral);
                    
                    newData[i] = Math.max(-1, Math.min(1, sample));
                }
            }
            
            return newBuffer;
        }
        
        function applyTimbreAdjustment(sample, ratio, spectral) {
            // محاكاة تعديل النغمة
            let adjusted = sample;
            
            if (spectral.brightness > 0.5) {
                adjusted = adjusted * (1 + ratio * 0.2);
            }
            
            if (spectral.warmth > 0.5) {
                adjusted = adjusted * (1 + ratio * 0.1);
            }
            
            return adjusted;
        }
        
        function downloadAudio() {
            if (!audioBuffer) {
                alert('لا يوجد صوت لتحميله');
                return;
            }
            
            const wavBlob = bufferToWave(audioBuffer, audioBuffer.length);
            const url = URL.createObjectURL(wavBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'voice_matched.wav';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function showStatus(message, type) {
            recordStatus.textContent = message;
            recordStatus.className = 'status';
            recordStatus.classList.add(type);
            
            if (type === 'recording') {
                recordStatus.innerHTML = `<div class="pulse"></div><span>${message}</span>`;
            } else {
                const icon = type === 'success' ? 'fa-check-circle' : 
                            type === 'processing' ? 'fa-sync-alt' : 'fa-info-circle';
                recordStatus.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
            }
            
            recordStatus.classList.remove('hidden');
        }
        
        // دالة تحويل AudioBuffer إلى WAV
        function bufferToWave(abuffer, len) {
            const numOfChan = abuffer.numberOfChannels;
            const length = len * numOfChan * 2;
            const buffer = new ArrayBuffer(44 + length);
            const view = new DataView(buffer);
            const channels = [];
            let i, sample;
            let offset = 0;
            let pos = 0;
            
            setUint32(0x46464952);
            setUint32(length + 36);
            setUint32(0x45564157);
            
            setUint32(0x20746d66);
            setUint32(16);
            setUint16(1);
            setUint16(numOfChan);
            setUint32(abuffer.sampleRate);
            setUint32(abuffer.sampleRate * 2 * numOfChan);
            setUint16(numOfChan * 2);
            setUint16(16);
            
            setUint32(0x61746164);
            setUint32(length);
            
            for (i = 0; i < abuffer.numberOfChannels; i++)
                channels.push(abuffer.getChannelData(i));
            
            while (pos < length) {
                for (i = 0; i < numOfChan; i++) {
                    sample = Math.max(-1, Math.min(1, channels[i][offset]));
                    sample = (0.5 + sample < 0 ? sample * 32768 : sample * 32767) | 0;
                    view.setInt16(pos, sample, true);
                    pos += 2;
                }
                offset++;
            }
            
            return new Blob([buffer], { type: 'audio/wav' });
            
            function setUint16(data) {
                view.setUint16(pos, data, true);
                pos += 2;
            }
            
            function setUint32(data) {
                view.setUint32(pos, data, true);
                pos += 4;
            }
        }
    </script>
</body>
</html>
